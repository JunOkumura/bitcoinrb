require 'spec_helper'

describe Bitcoin::Message::Tx do

  describe 'parse from payload' do

    context 'no use segwit' do # MSG_TX
      subject {
        Bitcoin::Message::Tx.parse_from_payload('010000000553719240c8624f9f0d80a8cc9f067176178336ca0f8a31539c5c749d4e714e4d03000000fdfe00004830450221008027faa1a0ab9d5476c39de3b9cd92120dd5100d52891f4466160fd51603167a0220183b58a4a9e109c129b489ee064ea5d5d93a953abda4faf4198a3fd776efd04101483045022100fe95ed912ea6e4b85ab42929dbf7f50493b17a9c9933c728871b280fcda070db0220176f893a2444cfa7f797f897b2b5001fef0502137130fa3dd5b956875078fc9b014c69522102aa05d9b4bb2e93d8b27f5b7be7b2c43c856795f14a5a277fac5e626e4b9fefbe2102d23c610c9cda2e33743036c93e837c830ea0662e71989001cc5066e88cbbe6f72103c110c7485bf0c3b1d1c0d5c74600c2bf6fe4cb9dad32a8e333ac4aaf7a24206253aeffffffffb7c9ddaceccf185ad464cea0fc72dc7e47e29d3ac1c0c2fa69145854477b0d0100000000fc0047304402202de4e27bab1bf3a91ec9eb57bc49301968671213fd37d40c2f809a58e9959c720220711eb9dfd74578f6562e0fdbe9a3bc9602e99e885b2ae88328398991ea29828a0147304402201a62a60dfbc51c1366a6c12ffd3307615edee6dd8fcf7148a6d165c427f122bb022048420c6cffb89968f2303f6771494a814962e3e1164755410e397e564cb91429014c69522102000455b4426f83dfd1045a3818b5fec22d833540661abbea6eeb2770232d52a921030cf72e76c921d0d2019a42924ac08c431edd889389dde79e584419cefdd233432103f5fc9ea29534c4f30f00a923ccdfc6a209652afdaa264fc69416606a6bc7c62453aeffffffff7b929c18638c5bf0a6184eb66c011cdb9ff1ade959c8d710c2c80efa3b3fd76903000000fc004730440220091b720e33174c64a68f7ca42066c9bef6471553c861e223cde0890a5e6136b1022003dac012592f922163c1c65692017f4f2ad21db91bf3288d54416d884731fb1b01473044022045aeeb6eb527d12f41b7ffc405b29f0ac6f85609c4cec455ddd31275036cd54d02207402a1418729ee298f95a991f5b087e25a852473f14fce49e6178dd4c3c7e922014c6952210317232383a9878dd8393a042f57c7657c59d9cd31c4aae1a41e348b2e3ad7ac0521035577d9bed96f8b4ac41805d757d546e1a16c1a68d0039e9a949354b6c72642032103718e9bc49e62c4589283a8028aa0d8f533422e0d602c972ed493ea0fccd213b553aeffffffff3d58febe2909a87018855ac7e053857e1b29b376655aaef3ab6b5c4a3b40620303000000fdfd000047304402204f6523b8fe24b1b942b23c5f4bb7ecd6334c45d0ddde4c29ec4d6aa55e84bfe102205f9551bca57ea563f501657e544e7fcdd6cc482c6a04d1eac699a682cd9c32c801483045022100e67bfdd7a25444fd795331a4c257fdafe54d3429d1ea2e87b127be1bbbd18887022065b0600683bffa163749024a32768cd7c23c59e040374b0ede11bd99e27369aa014c6952210240a9bc56fa8cf2028cb9c8eaccbcf8c4bae7d29f9a0ee4dec4d6428a59a5995921029ce5054c90020489a62d195bcd8ddddab563ce6e90c2e2a9efb882d8a8fa7beb2103742da09083a1dc781be2e0c04bfc3c1e55f0e98c614ebe47c689f9c95e25df4253aeffffffff78e21420a23df3e0d379f40ba8364ad232fb24255cb84a2b6109229f73af99f601000000fdfd000047304402207965668e0c7b5fed335c8a5145d0ce8c0816e9ef9b232117abc0678577d7cb0f02207211e2ec7a707223ce3cd964624583c95fd3027c8f69bf4922cac5a00994dd120148304502210082dbefc5d6eb06e78d490084f59badecd93315dafa13efb3a86b685b80677cf30220188bbd937c8b5d0458b3b02de825cd2bb34342b4fff0921cfd2e4189f9019d86014c6952210244411019872828c7481f60ab4f3c9cb61f0716131910951b76baa878edbaccf62102e4a0cffb8d87abf49dd3bbe8104474e96df1466c1c7e30180a2fe104100851cc210311aa090667831101d196fd0fc2db919613e88326c9a513a97e1108a29b16230553aeffffffff02533f00000000000017a914d0846f31ec305fbc9f24d1144555560bc2584abb872fff0c000000000017a914e9b2d888bc7cefd62df1fd3fbae4e3f73fb0009e8700000000'.htb)
      }
      it 'should be parsed' do
        expect(subject.tx.txid).to eq('c764b7556b3a689b0f691242967bfd3216c632e57503b0dd48d9e61db023d869')
        expect(subject.tx.inputs.length).to eq(5)
        expect(subject.tx.outputs.length).to eq(2)
      end
    end

    context 'use segwit' do # MSG_WITNESS_TX
      subject {
        Bitcoin::Message::Tx.parse_from_payload('01000000000101cfef3176137fe4db1ddc8ea1664ab5d6e97a9a9621ad9ccb988551039ac10b8c0000000000ffffffff01107a0700000000001976a91466f2f993a3e661501934f91772eab19a86701fa788ac0247304402206d9fac7b0eb73ebf7eeddb999e7708efffd793e1d6d0edffd34cce5e12e2f62d0220732f8c34f75e84e061253e590bf64cf61f2f35746be541b238683cc301bbb68f0121030f222cb92080f061c177019695e67810e1648718f52d1e8f6871b6122fe5495600000000'.htb)
      }
      it 'should be parsed' do
        expect(subject.tx.txid).to eq('77ea1dc2f080b9b61d26b701160a1048cb92d2457f25ca458937458ee111d9fa')
        expect(subject.tx.wtxid).to eq('c4a8b714e29804c9747a28e28c0ef38b8360968df344426d295f563d08fc0f79')
      end
    end

  end

  describe '#to_payload' do
    subject {
      tx = Bitcoin::Tx.parse_from_payload('010000000553719240c8624f9f0d80a8cc9f067176178336ca0f8a31539c5c749d4e714e4d03000000fdfe00004830450221008027faa1a0ab9d5476c39de3b9cd92120dd5100d52891f4466160fd51603167a0220183b58a4a9e109c129b489ee064ea5d5d93a953abda4faf4198a3fd776efd04101483045022100fe95ed912ea6e4b85ab42929dbf7f50493b17a9c9933c728871b280fcda070db0220176f893a2444cfa7f797f897b2b5001fef0502137130fa3dd5b956875078fc9b014c69522102aa05d9b4bb2e93d8b27f5b7be7b2c43c856795f14a5a277fac5e626e4b9fefbe2102d23c610c9cda2e33743036c93e837c830ea0662e71989001cc5066e88cbbe6f72103c110c7485bf0c3b1d1c0d5c74600c2bf6fe4cb9dad32a8e333ac4aaf7a24206253aeffffffffb7c9ddaceccf185ad464cea0fc72dc7e47e29d3ac1c0c2fa69145854477b0d0100000000fc0047304402202de4e27bab1bf3a91ec9eb57bc49301968671213fd37d40c2f809a58e9959c720220711eb9dfd74578f6562e0fdbe9a3bc9602e99e885b2ae88328398991ea29828a0147304402201a62a60dfbc51c1366a6c12ffd3307615edee6dd8fcf7148a6d165c427f122bb022048420c6cffb89968f2303f6771494a814962e3e1164755410e397e564cb91429014c69522102000455b4426f83dfd1045a3818b5fec22d833540661abbea6eeb2770232d52a921030cf72e76c921d0d2019a42924ac08c431edd889389dde79e584419cefdd233432103f5fc9ea29534c4f30f00a923ccdfc6a209652afdaa264fc69416606a6bc7c62453aeffffffff7b929c18638c5bf0a6184eb66c011cdb9ff1ade959c8d710c2c80efa3b3fd76903000000fc004730440220091b720e33174c64a68f7ca42066c9bef6471553c861e223cde0890a5e6136b1022003dac012592f922163c1c65692017f4f2ad21db91bf3288d54416d884731fb1b01473044022045aeeb6eb527d12f41b7ffc405b29f0ac6f85609c4cec455ddd31275036cd54d02207402a1418729ee298f95a991f5b087e25a852473f14fce49e6178dd4c3c7e922014c6952210317232383a9878dd8393a042f57c7657c59d9cd31c4aae1a41e348b2e3ad7ac0521035577d9bed96f8b4ac41805d757d546e1a16c1a68d0039e9a949354b6c72642032103718e9bc49e62c4589283a8028aa0d8f533422e0d602c972ed493ea0fccd213b553aeffffffff3d58febe2909a87018855ac7e053857e1b29b376655aaef3ab6b5c4a3b40620303000000fdfd000047304402204f6523b8fe24b1b942b23c5f4bb7ecd6334c45d0ddde4c29ec4d6aa55e84bfe102205f9551bca57ea563f501657e544e7fcdd6cc482c6a04d1eac699a682cd9c32c801483045022100e67bfdd7a25444fd795331a4c257fdafe54d3429d1ea2e87b127be1bbbd18887022065b0600683bffa163749024a32768cd7c23c59e040374b0ede11bd99e27369aa014c6952210240a9bc56fa8cf2028cb9c8eaccbcf8c4bae7d29f9a0ee4dec4d6428a59a5995921029ce5054c90020489a62d195bcd8ddddab563ce6e90c2e2a9efb882d8a8fa7beb2103742da09083a1dc781be2e0c04bfc3c1e55f0e98c614ebe47c689f9c95e25df4253aeffffffff78e21420a23df3e0d379f40ba8364ad232fb24255cb84a2b6109229f73af99f601000000fdfd000047304402207965668e0c7b5fed335c8a5145d0ce8c0816e9ef9b232117abc0678577d7cb0f02207211e2ec7a707223ce3cd964624583c95fd3027c8f69bf4922cac5a00994dd120148304502210082dbefc5d6eb06e78d490084f59badecd93315dafa13efb3a86b685b80677cf30220188bbd937c8b5d0458b3b02de825cd2bb34342b4fff0921cfd2e4189f9019d86014c6952210244411019872828c7481f60ab4f3c9cb61f0716131910951b76baa878edbaccf62102e4a0cffb8d87abf49dd3bbe8104474e96df1466c1c7e30180a2fe104100851cc210311aa090667831101d196fd0fc2db919613e88326c9a513a97e1108a29b16230553aeffffffff02533f00000000000017a914d0846f31ec305fbc9f24d1144555560bc2584abb872fff0c000000000017a914e9b2d888bc7cefd62df1fd3fbae4e3f73fb0009e8700000000'.htb)
      Bitcoin::Message::Tx.new(tx).to_pkt
    }
    it 'should be parsed' do
      expect(subject).to eq('0b1109077478000000000000000000000d06000069d823b0010000000553719240c8624f9f0d80a8cc9f067176178336ca0f8a31539c5c749d4e714e4d03000000fdfe00004830450221008027faa1a0ab9d5476c39de3b9cd92120dd5100d52891f4466160fd51603167a0220183b58a4a9e109c129b489ee064ea5d5d93a953abda4faf4198a3fd776efd04101483045022100fe95ed912ea6e4b85ab42929dbf7f50493b17a9c9933c728871b280fcda070db0220176f893a2444cfa7f797f897b2b5001fef0502137130fa3dd5b956875078fc9b014c69522102aa05d9b4bb2e93d8b27f5b7be7b2c43c856795f14a5a277fac5e626e4b9fefbe2102d23c610c9cda2e33743036c93e837c830ea0662e71989001cc5066e88cbbe6f72103c110c7485bf0c3b1d1c0d5c74600c2bf6fe4cb9dad32a8e333ac4aaf7a24206253aeffffffffb7c9ddaceccf185ad464cea0fc72dc7e47e29d3ac1c0c2fa69145854477b0d0100000000fc0047304402202de4e27bab1bf3a91ec9eb57bc49301968671213fd37d40c2f809a58e9959c720220711eb9dfd74578f6562e0fdbe9a3bc9602e99e885b2ae88328398991ea29828a0147304402201a62a60dfbc51c1366a6c12ffd3307615edee6dd8fcf7148a6d165c427f122bb022048420c6cffb89968f2303f6771494a814962e3e1164755410e397e564cb91429014c69522102000455b4426f83dfd1045a3818b5fec22d833540661abbea6eeb2770232d52a921030cf72e76c921d0d2019a42924ac08c431edd889389dde79e584419cefdd233432103f5fc9ea29534c4f30f00a923ccdfc6a209652afdaa264fc69416606a6bc7c62453aeffffffff7b929c18638c5bf0a6184eb66c011cdb9ff1ade959c8d710c2c80efa3b3fd76903000000fc004730440220091b720e33174c64a68f7ca42066c9bef6471553c861e223cde0890a5e6136b1022003dac012592f922163c1c65692017f4f2ad21db91bf3288d54416d884731fb1b01473044022045aeeb6eb527d12f41b7ffc405b29f0ac6f85609c4cec455ddd31275036cd54d02207402a1418729ee298f95a991f5b087e25a852473f14fce49e6178dd4c3c7e922014c6952210317232383a9878dd8393a042f57c7657c59d9cd31c4aae1a41e348b2e3ad7ac0521035577d9bed96f8b4ac41805d757d546e1a16c1a68d0039e9a949354b6c72642032103718e9bc49e62c4589283a8028aa0d8f533422e0d602c972ed493ea0fccd213b553aeffffffff3d58febe2909a87018855ac7e053857e1b29b376655aaef3ab6b5c4a3b40620303000000fdfd000047304402204f6523b8fe24b1b942b23c5f4bb7ecd6334c45d0ddde4c29ec4d6aa55e84bfe102205f9551bca57ea563f501657e544e7fcdd6cc482c6a04d1eac699a682cd9c32c801483045022100e67bfdd7a25444fd795331a4c257fdafe54d3429d1ea2e87b127be1bbbd18887022065b0600683bffa163749024a32768cd7c23c59e040374b0ede11bd99e27369aa014c6952210240a9bc56fa8cf2028cb9c8eaccbcf8c4bae7d29f9a0ee4dec4d6428a59a5995921029ce5054c90020489a62d195bcd8ddddab563ce6e90c2e2a9efb882d8a8fa7beb2103742da09083a1dc781be2e0c04bfc3c1e55f0e98c614ebe47c689f9c95e25df4253aeffffffff78e21420a23df3e0d379f40ba8364ad232fb24255cb84a2b6109229f73af99f601000000fdfd000047304402207965668e0c7b5fed335c8a5145d0ce8c0816e9ef9b232117abc0678577d7cb0f02207211e2ec7a707223ce3cd964624583c95fd3027c8f69bf4922cac5a00994dd120148304502210082dbefc5d6eb06e78d490084f59badecd93315dafa13efb3a86b685b80677cf30220188bbd937c8b5d0458b3b02de825cd2bb34342b4fff0921cfd2e4189f9019d86014c6952210244411019872828c7481f60ab4f3c9cb61f0716131910951b76baa878edbaccf62102e4a0cffb8d87abf49dd3bbe8104474e96df1466c1c7e30180a2fe104100851cc210311aa090667831101d196fd0fc2db919613e88326c9a513a97e1108a29b16230553aeffffffff02533f00000000000017a914d0846f31ec305fbc9f24d1144555560bc2584abb872fff0c000000000017a914e9b2d888bc7cefd62df1fd3fbae4e3f73fb0009e8700000000'.htb)
    end
  end

  describe '#sighash_for_input' do
    context 'non witness' do
      it 'should be generate' do
        # sighash all
        tx = Bitcoin::Tx.parse_from_payload('0100000001c997a5e56e104102fa209c6a852dd90660a20b2d9c352423edce25857fcd3704000000004847304402204e45e16932b8af514961a1d3a1a25fdf3f4f7732e9d624c6c61548ab5fb8cd410220181522ec8eca07de4860a4acdd12909d831cc56cbbac4622082221a8768d1d0901ffffffff0200ca9a3b00000000434104ae1a62fe09c5f51b13905f07f06b99a2f7159b2225f374cd378d71302fa28414e7aab37397f554a7df5f142c21c1b7303b8a0626f1baded5c72a704f7e6cd84cac00286bee0000000043410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac00000000'.htb)
        script_pubkey = '410411db93e1dcdb8a016b49840f8c53bc1eb68a382e97b1482ecad7b148a6909a5cb2e0eaddfb84ccf9744464f82e160bfa9b8b64f9d4c03f999b8643f656b412a3ac'.htb
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey).bth).to eq('7a05c6145f10101e9d6325494245adf1297d80f8f38d4d576d57cdba220bcb19')

        # sighash single
        tx = Bitcoin::Tx.parse_from_payload('0100000002dc38e9359bd7da3b58386204e186d9408685f427f5e513666db735aa8a6b2169000000006a47304402205d8feeb312478e468d0b514e63e113958d7214fa572acd87079a7f0cc026fc5c02200fa76ea05bf243af6d0f9177f241caf606d01fcfd5e62d6befbca24e569e5c27032102100a1a9ca2c18932d6577c58f225580184d0e08226d41959874ac963e3c1b2feffffffffdc38e9359bd7da3b58386204e186d9408685f427f5e513666db735aa8a6b2169010000006b4830450220087ede38729e6d35e4f515505018e659222031273b7366920f393ee3ab17bc1e022100ca43164b757d1a6d1235f13200d4b5f76dd8fda4ec9fc28546b2df5b1211e8df03210275983913e60093b767e85597ca9397fb2f418e57f998d6afbbc536116085b1cbffffffff0140899500000000001976a914fcc9b36d38cf55d7d5b4ee4dddb6b2c17612f48c88ac00000000'.htb)
        script_pubkey = '76a914fcc9b36d38cf55d7d5b4ee4dddb6b2c17612f48c88ac'.htb
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey,
                                    hash_type: Bitcoin::Script::SIGHASH_TYPE[:single]).bth).to eq('23563c6b270661cc38e940cd6f8908177b9c9de7ff5111e73481ec42a112a557')

        # sighash all | anyonecanpay
        tx = Bitcoin::Tx.parse_from_payload('0100000002f6044c0ad485f633b41f97d0d793eb2837ae40f738ff6d5f50fdfd10528c1d76010000006b48304502205853c7f1395785bfabb03c57e962eb076ff24d8e4e573b04db13b45ed3ed6ee20221009dc82ae43be9d4b1fe2847754e1d36dad48ba801817d485dc529afc516c2ddb481210305584980367b321fad7f1c1f4d5d723d0ac80c1d80c8ba12343965b48364537affffffff9c6af0df6669bcded19e317e25bebc8c78e48df8ae1fe02a7f030818e71ecd40010000006c4930460221008269c9d7ba0a7e730dd16f4082d29e3684fb7463ba064fd093afc170ad6e0388022100bc6d76373916a3ff6ee41b2c752001fda3c9e048bcff0d81d05b39ff0f4217b2812103aae303d825421545c5bc7ccd5ac87dd5add3bcc3a432ba7aa2f2661699f9f659ffffffff01e0930400000000001976a9145c11f917883b927eef77dc57707aeb853f6d389488ac00000000'.htb)
        script_pubkey = '76a9148551e48a53decd1cfc63079a4581bcccfad1a93c88ac'.htb
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey,hash_type:
            Bitcoin::Script::SIGHASH_TYPE[:all] | Bitcoin::Script::SIGHASH_TYPE[:anyonecanpay]).bth).to eq('acf290d5617704f1aad0a0d00a93b60886dac5df3c46b2e49d0344a94670d537')

        # sighash single | anyonecanpay
        tx = Bitcoin::Tx.parse_from_payload('0100000001774431e6ccca53548400e2e8bb66865ca2feef7885f09a0199b5fdd0eeb7583e01000000dc004930460221008662e2bfcc4741d92531f566c5765d849e24b45c289607593584fbba938d88cc022100d718e710d5991bdfbdc5b0d52ae8e4d9c1c1c719bcc348003c5e80524a04e16283483045022100fbdbea6b614989b210d269dbf171746a9507bb3dae292bdaf85848a7aa091eca02205d23a46269a904c40076c76eadfdb8f98e7d0349c0bfe5915cca3f8835a4a41683475221034758cefcb75e16e4dfafb32383b709fa632086ea5ca982712de6add93060b17a2103fe96237629128a0ae8c3825af8a4be8fe3109b16f62af19cec0b1eb93b8717e252aeffffffff0280969800000000001976a914f164a82c9b3c5d217c83380792d56a6261f2d17688ac609df200000000001976a9142ab55d985e552653c189b1530aac817c0223cb4c88ac00000000'.htb)
        script_pubkey = 'a914d0c15a7d41500976056b3345f542d8c944077c8a87'.htb
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey,hash_type:
            Bitcoin::Script::SIGHASH_TYPE[:single] | Bitcoin::Script::SIGHASH_TYPE[:anyonecanpay]).bth).to eq('5e7f5c6e6a9f1a751a1686a88a42416223cccaed0898992961c498901a40dbb1')

        # sighash none
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey,hash_type:
            Bitcoin::Script::SIGHASH_TYPE[:none]).bth).to eq('736918827173aa332b97c1ebe2f2cdae046034a553932a303238a34609e8b31a')

        # sighash none | anyonecanpay
        expect(tx.sighash_for_input(input_index: 0, script_pubkey: script_pubkey,hash_type:
            Bitcoin::Script::SIGHASH_TYPE[:none] | Bitcoin::Script::SIGHASH_TYPE[:anyonecanpay]).bth).to eq('a94ba0fd2c08b5b753282f15483901714bb862fd37b9339b38dec31e6d4c793d')
      end
    end

    context 'witness' do
      # TODO
    end

  end

end